# Makefile for Eclipse Paho C MQTT Client

BREW_PREFIX=/opt/homebrew

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -I$(BREW_PREFIX)/include
#LDFLAGS =-ljson-c -lssl -lcrypto
LDFLAGS = -L$(BREW_PREFIX)/lib -L/usr/local/lib -lpaho-mqtt3cs -ljson-c
# -lpaho-mqtt3cs
# /opt/homebrew/Cellar/json-c/0.18/lib/libjson-c.a

# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
TARGET = iot_mqtt_client
SOURCES = paho_c_mqtt_client.c
OBJECTS = $(SOURCES:.c=.o)

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
all: $(TARGET)

# å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
$(TARGET): $(OBJECTS)
	@echo "ğŸ”¨ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆä¸­..."
	$(CC) $(OBJECTS) -o $(TARGET) $(LDFLAGS)
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†: $(TARGET)"

# ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
%.o: %.c
	@echo "ğŸ”§ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸­: $<"
	$(CC) $(CFLAGS) -c $< -o $@

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Ubuntu/Debianç”¨)
install-deps-ubuntu:
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ (Ubuntu/Debian)..."
	sudo apt update
	sudo apt install -y build-essential cmake git
	sudo apt install -y libssl-dev libpaho-mqtt-dev libjson-c-dev
	@echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (CentOS/RHEL/Fedoraç”¨)
install-deps-rhel:
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ (CentOS/RHEL/Fedora)..."
	sudo yum groupinstall -y "Development Tools"
	sudo yum install -y cmake git openssl-devel json-c-devel
	@echo "âš ï¸  Paho MQTTãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ‰‹å‹•ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„"
	@echo "   è©³ç´°ã¯ README ã‚’å‚ç…§"

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (macOSç”¨)
install-deps-macos:
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ (macOS)..."
	@if ! command -v brew >/dev/null 2>&1; then \
		echo "âŒ Homebrew ãŒå¿…è¦ã§ã™"; \
		echo "   /bin/bash -c \"\$$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""; \
		exit 1; \
	fi
	brew install cmake git openssl json-c libpaho-mqtt
	@echo "âš ï¸  Paho MQTTãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ‰‹å‹•ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„"
	@echo "   è©³ç´°ã¯ README ã‚’å‚ç…§"

# Paho MQTT Cãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ“ãƒ«ãƒ‰ï¼ˆæ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ï¼‰
build-paho:
	@echo "ğŸš€ Paho MQTT C ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@if [ ! -d "paho.mqtt.c" ]; then \
		git clone https://github.com/eclipse-paho/paho.mqtt.c.git; \
	fi
	cd paho.mqtt.c && \
	cmake -Bbuild -H. -DPAHO_ENABLE_TESTING=OFF -DPAHO_BUILD_STATIC=OFF \
	-DPAHO_WITH_SSL=ON -DPAHO_HIGH_PERFORMANCE=ON && \
	cmake --build build/ --target install
	@echo "âœ… Paho MQTT ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ“ãƒ«ãƒ‰å®Œäº†"

# å®Ÿè¡Œ
run: $(TARGET)
	@echo "ğŸš€ MQTT ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè¡Œä¸­..."
	@echo "âš ï¸  è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¨è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
	./$(TARGET)

# è¨¼æ˜æ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
setup-certs:
	@echo "ğŸ“ è¨¼æ˜æ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆä¸­..."
	mkdir -p certificates
	@echo "âœ… certificates/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
	@echo ""
	@echo "ğŸ“ å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«:"
	@echo "  certificates/certificate.pem.crt  - ãƒ‡ãƒã‚¤ã‚¹è¨¼æ˜æ›¸"
	@echo "  certificates/private.pem.key      - ç§˜å¯†éµ"
	@echo "  certificates/AmazonRootCA1.pem    - ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸"
	@echo ""
	@echo "ğŸŒ AmazonRootCA1.pem ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:"
	@echo "  curl -o certificates/AmazonRootCA1.pem https://www.amazontrust.com/repository/AmazonRootCA1.pem"

# ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
download-root-ca:
	@echo "ğŸ“¥ Amazon Root CA è¨¼æ˜æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
	curl -o certificates/AmazonRootCA1.pem https://www.amazontrust.com/repository/AmazonRootCA1.pem
	@echo "âœ… AmazonRootCA1.pem ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ"

# è¨­å®šç¢ºèª
check-config:
	@echo "ğŸ” è¨­å®šã¨è¨¼æ˜æ›¸ã‚’ç¢ºèªä¸­..."
	@echo ""
	@echo "ğŸ“‚ è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«:"
	@for file in certificates/certificate.pem.crt certificates/private.pem.key certificates/AmazonRootCA1.pem; do \
		if [ -f "$$file" ]; then \
			echo "  âœ… $$file"; \
		else \
			echo "  âŒ $$file (è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)"; \
		fi \
	done
	@echo ""
	@echo "âš™ï¸  è¨­å®šç¢ºèª:"
	@echo "  ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: YOUR_ACCOUNT_ID.iot.ap-northeast-1.amazonaws.com ã‚’å®Ÿéš›ã®å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„"
	@echo "  Thingå: custom-device-001"
	@echo "  ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID: custom-device-001"

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	@echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	rm -f $(OBJECTS) $(TARGET)
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean-all: clean
	@echo "ğŸ—‘ï¸  å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	rm -rf paho.mqtt.c
	@echo "âœ… å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰
debug: CFLAGS += -DDEBUG -g
debug: $(TARGET)

# ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒƒã‚¯å®Ÿè¡Œ
test-mock:
	@echo "ğŸ§ª ãƒ¢ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
	@echo "   å®Ÿéš›ã®AWS IoTã«æ¥ç¶šã›ãšã«ãƒ†ã‚¹ãƒˆ"
	$(CC) $(CFLAGS) -DMOCK_TEST -o $(TARGET)_mock $(SOURCES) $(LDFLAGS)
	./$(TARGET)_mock

# ãƒ˜ãƒ«ãƒ—
help:
	@echo "ğŸ”§ ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo ""
	@echo "  make                    - ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make install-deps-ubuntu - Ubuntu/Debianç”¨ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make install-deps-rhel  - CentOS/RHEL/Fedoraç”¨ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make install-deps-macos - macOSç”¨ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make build-paho         - Paho MQTT Cãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ‰‹å‹•ãƒ“ãƒ«ãƒ‰"
	@echo "  make setup-certs        - è¨¼æ˜æ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ"
	@echo "  make download-root-ca   - Amazon Root CAè¨¼æ˜æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
	@echo "  make check-config       - è¨­å®šã¨è¨¼æ˜æ›¸ã‚’ç¢ºèª"
	@echo "  make run                - ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œ"
	@echo "  make clean              - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo "  make clean-all          - å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo "  make debug              - ãƒ‡ãƒãƒƒã‚°ç‰ˆã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make help               - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"

.PHONY: all clean clean-all install-deps-ubuntu install-deps-rhel install-deps-macos build-paho setup-certs download-root-ca check-config run debug test-mock help
